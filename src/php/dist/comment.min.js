function googleCallback(){gapi.client.setApiKey(document.getElementById("comment-module").dataset.ggApikey);gapi.client.load("plus","v1",function(){})}var CommentModule={data:{user:{name:null,phone:null,email:null,avatar:null}},formatDate:function(n){var t,r,i;if(typeof n=="string"&&(n=parseInt(n)),t=new Date(n),r=[],!t)return"Gần đây";for(i=1;i<13;i++)r.push("Tháng "+i);var u=t.getDate(),f=r[t.getMonth()],e=t.getFullYear(),o=t.getHours()<10?"0"+t.getHours():t.getHours(),s=t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes();return[u,f,e].join("/")+" "+[o,s].join(":")},renderComments:function(n){var t=this;if(!n.length)return t.initSubmitForm(),$("#comment-module .no-comments").show(),0;$(".comment-list").empty();n.forEach(function(n){var r=$('<div class="media" />'),f=$('<img class="d-flex mr-3" src="img/avatar.jpg" />'),o=$('<p class="comment-title">').html($("<strong/>").html(n.name)),s=$('<p class="comment-text"/>').html(n.comment),h=$('<div class="comment-action" />'),c=t.formatDate(n.time),l=$('<a href="javascript:(0)">Phản hồi<\/a>'),e,u,i;l.on("click",function(){$("#comment-"+n.id+" .sub-form").addClass("show")});n.avatar&&n.avatar!=""&&f.attr("src",n.avatar);e=$('<div class="media-body"/>');n.pid?(r.html(f).append(e.html(o).append(s).append(h.append(c))),u=$("#comment-"+n.pid),u.length&&(i=u.find(".comment-replies"),i.length?i.append($('<li id="comment-'+n.id+'" />').html(r)):(i=$('<ul class="list-unstyled comment-replies" />'),i.append($('<li id="comment-'+n.id+'" />').html(r)),u.append(i)))):(r.html(f).append(e.html(o).append(s).append(h.html(l).append(c))),$(".comment-list").append($('<li id="comment-'+n.id+'" />').html(r)))});$(".comment-list > li").each(function(){var n=$('<form class="form-reply sub-form" />'),t=$(this).attr("id").split("-")[1];n.append('<textarea name="text" placeholder="Thêm trả lời bình luận" maxlength="500" rows="1"><\/textarea>');n.append('<input type="hidden" name="pid" value="'+t+'" />');n.append('<button type="submit" name="submitForm">Gửi<\/button>');n.append('<span class="counter">Bạn còn <strong>500<\/strong> ký tự còn lại<\/span>');$(this).append(n)});t.initSubmitForm()},loadComments:function(){var n=this;$.ajax({type:"GET",url:window.commentURL+"/get.php",dataType:"json",success:function(t){n.renderComments(t)}})},sendComment:function(n,t){var i=this;$.ajax({type:"POST",url:window.commentURL+"/send.php",data:t||{},dataType:"json",complete:function(n){n.responseText&&i.loadComments()}})},facebook:{data:{appId:document.getElementById("comment-module").dataset.fbAppid||null},init:function(){var n=this;console.log(n.data.appId);FB.init({appId:n.data.appId,xfbml:!0,status:!0,cookie:!0,oauth:!0})},status:function(n){var t={isLogin:!1,uid:"",accessToken:""};FB.getLoginStatus(function(i){i.status==="connected"&&(t.uid=i.authResponse.userID,t.accessToken=i.authResponse.accessToken,t.isLogin=!0);n&&typeof n=="function"&&n(t)})},login:function(n){var t={status:"fail"};FB.login(function(i){i.status==="connected"&&(t.status="complete");n&&typeof n=="function"&&n(t)},{scope:"email,public_profile"})},getUser:function(n){var i=$.Deferred(),t=$.Deferred();FB.api("/me?fields=id,name,email",function(n){i.resolve(n)});FB.api("/me/picture?width=180&height=180",function(n){n.data&&n.data.url?t.resolve(n.data.url):t.resolve("")});$.when(i,t).done(function(t,i){n&&typeof n=="function"&&n({name:t.name,email:t.email,avatar:i})})}},google:{login:function(n){var t={clientid:document.getElementById("comment-module").dataset.ggClientid+".apps.googleusercontent.com",cookiepolicy:"single_host_origin",callback:n,approvalprompt:"force",scope:"https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/plus.profile.emails.read"};gapi.auth.signIn(t)},getUser:function(n,t){var u=this,r;n.status.signed_in&&(r={},gapi.client.load("plus","v1",function(){var n=gapi.client.plus.people.get({userId:"me"});n.execute(function(n){var u="";if(n.emails)for(i=0;i<n.emails.length;i++)n.emails[i].type=="account"&&(u=n.emails[i].value);r.name=n.displayName;r.avatar=n.image.url;r.email=u;r.avatar=r.avatar.replace(/sz=50/ig,"sz=100");t&&typeof t=="function"&&t(r)})}))}},initSubmitForm:function(){var n=this;$("#comment-module form.form-reply").each(function(){var t=$(this);t.find("textarea").keyup(function(){var n=$(this).val().length;n>=500?val.value=val.value.substring(0,500):t.find(".counter > strong").text(500-n)});t.unbind("submit");t.bind("submit",function(){var u=t.find("textarea").val(),r=null,i;if(t.find('[name="pid"]').length&&(r=t.find('[name="pid"]').val()),u.length<30)return alert("Bình luận phải trên 30 ký tự!"),!1;if(n.data.user.name)i=n.data.user,i.comment=u,r&&(i.pid=r),n.sendComment(null,i);else{try{$("#infoModal").modal("show");$("#infoForm").submit(function(){var f={name:$('#infoModal [name="name"]').val(),email:$('#infoModal [name="email"]').val(),phone:$('#infoModal [name="phone"]').val(),avatar:$('#infoModal [name="avatar"]').val()};for(var e in i)f[i[e].split("=")[0]]=i[e].split("=")[1];return f.comment=u,r&&(f.pid=r),n.sendComment(null,f),$("#infoModal").modal("hide"),t.find("textarea").val(""),!1});$("#btnOpenFB").unbind("click");$("#btnOpenFB").bind("click",function(){var t=$(this);t.attr("disabled",!0);n.facebook.status(function(i){i.isLogin?n.facebook.getUser(function(n){t.attr("disabled",!1);f(n)}):n.facebook.login(function(i){i.status=="success"?n.facebook.getUser(function(n){t.attr("disabled",!1);f(n)}):(alert("Không kết nối được tài khoản Facebook của bạn!"),t.attr("disabled",!1))})})});$("#btnOpenGG").unbind("click");$("#btnOpenGG").bind("click",function(){n.google.login(function(t){n.google.getUser(t,function(n){f(n)})})})}catch(e){return console.error(e),!1}function f(t){n.data.user=t;$('#infoModal [name="name"]').val(t.name);$('#infoModal [name="email"]').val(t.email);$('#infoModal [name="phone"]').val(t.phone);$('#infoModal [name="avatar"]').val(t.avatar);$('#infoForm [type="submit"]').trigger("click")}}return!1})})},init:function(){var n=this;if(!window.$)return!1;n.facebook.init();n.loadComments()}};